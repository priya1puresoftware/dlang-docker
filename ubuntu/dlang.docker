FROM ubuntu:latest

ENV D_VERSION=ldc-1.26.0
ENV BIN_FOLDER=bin
ENV LIB_FOLDER=lib
ENV DEBIAN_FRONTEND=noninteractive
ENV DPATH=/dlang

RUN set -ex && \
	apt-get update && \
	apt-get install --no-install-recommends -y \
	ca-certificates \
	curl \
	libc6-dev \
	gcc \
	libevent-dev \
	libssl-dev \
	libxml2 \
	libz-dev \
	gpg \
	make \
	xz-utils \
	&& update-alternatives --install "/usr/bin/ld" "ld" "/usr/bin/ld.gold" 20 \
	&& update-alternatives --install "/usr/bin/ld" "ld" "/usr/bin/ld.bfd" 10

RUN groupadd --gid 1000 dlang \
  && useradd --uid 1000 --gid dlang --shell /bin/bash --create-home dlang

RUN mkdir ${DPATH}\
    && chown dlang ${DPATH}

USER dlang

RUN set -ex && \
	curl -fsS https://dlang.org/install.sh | bash -s ${D_VERSION} -p ${DPATH}

USER root

RUN chmod 755 -R ${DPATH}
RUN ln -s ${DPATH}/${D_VERSION} ${DPATH}/dc && ls ${DPATH}

ENV PATH="${DPATH}/${D_VERSION}/${BIN_FOLDER}:${PATH}"
ENV LIBRARY_PATH="${DPATH}/${D_VERSION}/${LIB_FOLDER}:${LIBRARY_PATH}"
ENV LD_LIBRARY_PATH="${DPATH}/${D_VERSION}/${LIB_FOLDER}:${LD_LIBRARY_PATH}"
